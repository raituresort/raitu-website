<?php
require_once __DIR__ . '/db.php';

if(isset($_POST['add_user'])){
    $name = $_POST['name'];
    $email = $_POST['email'];
    $image = '';

    if(isset($_FILES['image']) && $_FILES['image']['name']!=''){
        $image = time().'_'.$_FILES['image']['name'];
        move_uploaded_file($_FILES['image']['tmp_name'],'uploads/'.$image);
    }

    mysqli_query($conn,"INSERT INTO users(name,email,image) VALUES('$name','$email','$image')");
    header("Location: dashboard.php");
    exit;
}

if(isset($_POST['edit_user'])){
    $id = $_POST['id'];
    $name = $_POST['name'];
    $email = $_POST['email'];
    $image = $_POST['old_image'];

    if(isset($_FILES['image']) && $_FILES['image']['name']!=''){
        if(!empty($image) && file_exists('uploads/'.$image)) unlink('uploads/'.$image);
        $image = time().'_'.$_FILES['image']['name'];
        move_uploaded_file($_FILES['image']['tmp_name'],'uploads/'.$image);
    }

    mysqli_query($conn,"UPDATE users SET name='$name', email='$email', image='$image' WHERE id=$id");
    header("Location: dashboard.php");
    exit;
}

if(isset($_GET['action']) && $_GET['action']=='delete'){
    $id = $_GET['id'];
    $res = mysqli_query($conn,"SELECT image FROM users WHERE id=$id");
    $row = mysqli_fetch_assoc($res);
    if(!empty($row['image']) && file_exists('uploads/'.$row['image'])) unlink('uploads/'.$row['image']);
    mysqli_query($conn,"DELETE FROM users WHERE id=$id");
    header("Location: dashboard.php");
    exit;
}
?>
